<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Rainfall Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      color: #fff;
      position: relative;
      min-height: 100vh;
      overflow-x: hidden;
      background: url('/static/bg_1.jpg') no-repeat center center fixed;
      background-size: cover;
    }



    h1 {
      text-align: center;
      position: relative;k
      z-index: 2;
      font-size: 32px;
      font-weight: 700;
      color: #ffd700;
      text-shadow: 2px 2px 10px rgba(0,0,0,0.7);
      margin-bottom: 15px;
    }

    .date-boxes {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 20px 0;
      position: relative;
      z-index: 2;
      flex-wrap: wrap;
    }

    .date-box {
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(6px);
      padding: 18px 28px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      color: #fff;
      font-family: 'Roboto', sans-serif;
    }

    .date-box h3 { font-weight: 700; margin-bottom: 8px; color: #ffd700; }

    .wiki-link {
      display: block;
      text-align: center;
      margin-bottom: 25px;
      position: relative;
      z-index: 2;
      color: #ff4d00ff;
      text-decoration: none;
      font-weight: 600;
      font-size: 20px;
    }
    .wiki-link:hover { text-decoration: underline; }

    #chart {
      max-width: 750px;
      margin: 0 auto 30px auto;
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
      position: relative;
      z-index: 2;
    }

    table {
      margin: 0 auto 40px auto;
      border-collapse: collapse;
      width: 85%;
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
      overflow: hidden;
      color: #fff;
      font-family: 'Roboto', sans-serif;
      box-shadow: 0 0 15px rgba(0,0,0,0.6);
      position: relative;
      z-index: 2;
    }

    th, td {
      padding: 12px 15px;
      text-align: center;
    }

    th {
      background: rgba(255, 215, 0, 0.8);
      color: #000;
      font-weight: 700;
      font-size: 15px;
    }

    tr:nth-child(even) { background: rgba(255,255,255,0.1); }
    tr:nth-child(odd) { background: rgba(0,0,0,0.2); }

    td { font-size: 14px; font-weight: 500; }

    a.back {
      display: inline-block;
      margin: 0 auto 50px auto;
      background: linear-gradient(90deg,#5B2C6F,#8E44AD);
      color: #fff;
      text-decoration: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 15px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      position: relative;
      z-index: 2;
      transition: 0.3s ease;
    }
    a.back:hover { background: linear-gradient(90deg,#76448A,#9B59B6); transform: scale(1.05); }

    .filter-btn {
      background: rgba(0,0,0,0.5);
      color: #fff;
      border: 1px solid #ffd700;
      padding: 6px 12px;
      margin: 0 5px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: 0.3s;
    }
    .filter-btn:hover, .filter-btn.active {
      background: #ffd700;
      color: #000;
    }

    /* Farming Advice Section */
    .farming-advice {
      background: rgba(0, 0, 0, 0.6);
      padding: 20px;
      border-radius: 12px;
      margin: 20px auto;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      max-width: 90%;
      text-align: center;
    }
    .farming-advice h2 {
      font-size: 24px;
      margin-bottom: 15px;
      color: #ffd700;
    }
    .farming-advice p {
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 10px;
    }

    @media (max-width: 768px) {
      #map { width: 95%; }
      .controls { flex-direction: column; align-items: center; }
      .farming-advice { max-width: 95%; }
    }

  </style>
</head>
<body>
  <h1>üåßÔ∏è Rainfall Prediction Results</h1>

  <div id="rain-alert" style="display: none; text-align: center; background: rgba(255, 215, 0, 0.8); color: #000; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-weight: 600;">‚ö†Ô∏è Remember to carry an umbrella as a precaution if there's rain!</div>

  <div class="date-boxes">
    <div class="date-box">
      <h3>Start Date</h3>
      <p>{{ results.start_date }}</p>
    </div>
    <div class="date-box">
      <h3>End Date</h3>
      <p>{{ results.end_date }}</p>
    </div>
  </div>

  <a class="wiki-link" href="{{ results.wiki_link }}" target="_blank">üîó View on Wikipedia</a>

  <!-- Farming Advice Section -->
  {% if results.farming_suggestions %}
  <div class="farming-advice">
    <h2>üåæ Farming Suggestions</h2>
    <ul style="text-align: left; display: inline-block;">
      {% for suggestion in results.farming_suggestions %}
      <li>{{ suggestion }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div id="chart">
    <div style="text-align: center; margin-bottom: 10px;">
      <button id="toggleChart" style="background: linear-gradient(90deg,#5B2C6F,#8E44AD); color: #fff; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">Switch to Line Chart</button>
    </div>
    <canvas id="rainChart"></canvas>
  </div>

  <div style="text-align: center; margin: 20px 0;">
    <label style="color: #fff; font-weight: 600; margin-right: 10px;">Filter by Rainfall Type:</label>
    <button class="filter-btn active" data-type="all">All</button>
    <button class="filter-btn" data-type="No rain">No rain</button>
    <button class="filter-btn" data-type="Drizzle">Drizzle</button>
    <button class="filter-btn" data-type="Light rain">Light rain</button>
    <button class="filter-btn" data-type="Moderate rain">Moderate rain</button>
    <button class="filter-btn" data-type="Heavy rain">Heavy rain</button>
  </div>

    <table id="resultsTable">
      <thead>
        <tr><th>Date</th><th>Predicted Rainfall (mm)</th><th>Rainfall Type</th><th>Weather</th></tr>
      </thead>
      <tbody>
        {% for p in results.predictions %}
        <tr data-type="{{ p.rainfall_type }}">
          <td>{{ p.date }}</td>
          <td>{{ p.rainfall }}</td>
          <td>{{ p.rainfall_type }}</td>
          <td>{{ p.icon }} {{ p.weather }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  <div style="text-align:center; margin-bottom: 20px;">
    <button id="exportBtn" style="background: linear-gradient(90deg,#5B2C6F,#8E44AD); color: #fff; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 700; font-size: 15px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.5); transition: 0.3s ease;">üìä Export to CSV</button>
  </div>

  <div style="text-align:center;">
    <a class="back" href="{{ url_for('home') }}">üîô Back to Map</a>
  </div>

  <script>
    const predictions = {{ results.predictions | tojson }};
    const fullLabels = {{ results.predictions | map(attribute='date') | list | tojson }};
    const fullData = {{ results.predictions | map(attribute='rainfall') | list | tojson }};
    const fullTypes = {{ results.predictions | map(attribute='rainfall_type') | list | tojson }};

    // Check for rain and show alert
    let hasRain = false;
    let hasHeavyRain = false;
    for (let p of predictions) {
      if (p.rainfall > 0) {
        hasRain = true;
      }
      if (p.rainfall_type === 'Heavy rain') {
        hasHeavyRain = true;
      }
    }
    if (hasRain) {
      document.getElementById('rain-alert').style.display = 'block';
    }


    const ctx = document.getElementById('rainChart').getContext('2d');

    // Gradient fill for chart
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(255, 215, 0, 0.9)');
    gradient.addColorStop(1, 'rgba(255, 215, 0, 0.3)');

    let chartType = 'bar';
    let chart = new Chart(ctx, {
      type: chartType,
      data: {
        labels: fullLabels,
        datasets: [{
          label: 'Rainfall (mm)',
          data: fullData,
          backgroundColor: gradient,
          borderColor: '#ffd700',
          borderWidth: 1,
          borderRadius: 5,
          fill: chartType === 'line' ? false : true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: '#ffd700', font: { weight: 600, size: 14 } } }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#fff', font: { weight: 500, size: 13 } },
            grid: { color: 'rgba(255,255,255,0.2)' }
          },
          x: {
            ticks: { color: '#fff', font: { weight: 500, size: 13 } },
            grid: { color: 'rgba(255,255,255,0.1)' }
          }
        }
      }
    });

    // Toggle chart type
    document.getElementById('toggleChart').addEventListener('click', function() {
      chartType = chartType === 'bar' ? 'line' : 'bar';
      chart.config.type = chartType;
      chart.data.datasets[0].fill = chartType === 'line' ? false : true;
      chart.update();
      this.textContent = chartType === 'bar' ? 'Switch to Line Chart' : 'Switch to Bar Chart';
    });

    // Filter functionality (affects only the chart)
    const filterButtons = document.querySelectorAll('.filter-btn');

    filterButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const filterType = this.getAttribute('data-type');
        filterButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        let filteredLabels = [];
        let filteredData = [];

        if (filterType === 'all') {
          filteredLabels = fullLabels;
          filteredData = fullData;
        } else {
          fullLabels.forEach((label, index) => {
            if (fullTypes[index] === filterType) {
              filteredLabels.push(label);
              filteredData.push(fullData[index]);
            }
          });
        }

        chart.data.labels = filteredLabels;
        chart.data.datasets[0].data = filteredData;
        chart.update();
      });
    });

    // Export to CSV functionality
    document.getElementById('exportBtn').addEventListener('click', function() {
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Date,Predicted Rainfall (mm),Rainfall Type,Weather\n";

      predictions.forEach(p => {
        csvContent += `${p.date},${p.rainfall},${p.rainfall_type},${p.weather}\n`;
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "rainfall_predictions.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
